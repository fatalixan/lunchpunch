<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Restaurant DB</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <div id="notifyBox" class="fixed top-4 right-4 hidden px-4 py-2 rounded shadow-lg"></div>

  <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-lg p-6">
    <h1 class="text-2xl font-bold mb-4">üìã Restaurant Database Manager</h1>

    <!-- –í—ã–±–æ—Ä —Ç–∞–±–ª–∏—Ü—ã -->
    <div class="mb-4 flex items-center gap-2">
      <label class="font-semibold">–¢–∞–±–ª–∏—Ü–∞:</label>
      <select id="tableSelect" class="border p-2 rounded"></select>
      <button onclick="loadData()" class="ml-2 bg-blue-500 text-white px-4 py-2 rounded">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>

    <!-- –ü–æ–∏—Å–∫ -->
    <div class="mb-4">
      <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="üîç –ü–æ–∏—Å–∫..." 
             class="w-full border p-2 rounded" />
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <table id="dataTable" class="table-auto w-full border-collapse border border-gray-300">
      <thead class="bg-gray-200"></thead>
      <tbody></tbody>
    </table>

    <!-- –§–æ—Ä–º–∞ -->
    <div id="formContainer" class="mt-6 p-4 border rounded bg-gray-50 hidden">
      <h2 class="text-xl font-semibold mb-2" id="formTitle">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h2>
      <form id="recordForm" class="space-y-3"></form>
      <button onclick="submitForm()" class="bg-green-500 text-white px-4 py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="cancelForm()" class="ml-2 bg-gray-500 text-white px-4 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

<script>
// ====================
// –°–ª–æ–≤–∞—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π:
// Supplier        -> –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏
// Category        -> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
// Product         -> –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
// MeasurementUnit -> –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
// ProductItem     -> –ü—Ä–æ–¥—É–∫—Ü–∏—è
// Recipes         -> –†–µ—Ü–µ–ø—Ç—ã
// SeasonMenu      -> –°–µ–∑–æ–Ω–Ω–æ–µ –º–µ–Ω—é
// ====================

const tableNames = {
  Supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏",
  Category: "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏",
  Product: "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã",
  MeasurementUnit: "–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è",
  ProductItem: "–ü—Ä–æ–¥—É–∫—Ü–∏—è",
  Recipes: "–†–µ—Ü–µ–ø—Ç—ã",
  SeasonMenu: "–°–µ–∑–æ–Ω–Ω–æ–µ –º–µ–Ω—é"
};

let currentTable = "";
let editId = null;
let currentHeaders = [];
let loadedData = [];

function initTableSelect() {
  const select = document.getElementById("tableSelect");
  select.innerHTML = "";
  Object.keys(tableNames).forEach(tbl => {
    const opt = document.createElement("option");
    opt.value = tbl;
    opt.textContent = tableNames[tbl];
    select.appendChild(opt);
  });
}

function notify(msg, type="success") {
  const box = document.getElementById("notifyBox");
  box.innerText = msg;
  box.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg text-white ${
    type==="success" ? "bg-green-500" : "bg-red-500"
  }`;
  box.classList.remove("hidden");
  setTimeout(() => box.classList.add("hidden"), 2500);
}

async function loadData() {
  currentTable = document.getElementById("tableSelect").value;
  const res = await fetch(`api.php?table=${currentTable}&action=list`);
  loadedData = await res.json();
  renderTable(loadedData);
}

function renderTable(data) {
  const thead = document.querySelector("#dataTable thead");
  const tbody = document.querySelector("#dataTable tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (!data.length) {
    tbody.innerHTML = `<tr><td class="p-2 text-center" colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    return;
  }

  currentHeaders = Object.keys(data[0]).filter(h => h !== "created_at" && h !== "updated_at");
  thead.innerHTML = `<tr>${currentHeaders.map(h => `<th class="border px-3 py-2">${h}</th>`).join("")}<th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>`;

  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.setAttribute("id", `row_${row.ID}`);
    tr.innerHTML = currentHeaders.map(h => `<td class="border px-3 py-2">${row[h]}</td>`).join("")
      + `<td class="border px-3 py-2">
          <button onclick="showForm('edit', ${row.ID})" class="bg-yellow-500 text-white px-2 py-1 rounded">–†–µ–¥–∞–∫—Ç</button>
          <button onclick="deleteRow('${currentTable}', ${row.ID})" class="ml-1 bg-red-500 text-white px-2 py-1 rounded">–£–¥–∞–ª–∏—Ç—å</button>
        </td>`;
    tbody.appendChild(tr);
  });

  const addRow = document.createElement("tr");
  addRow.innerHTML = `<td colspan="${currentHeaders.length + 1}" class="p-2 text-center">
    <button onclick="showForm('create')" class="bg-blue-600 text-white px-4 py-2 rounded">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
  </td>`;
  tbody.appendChild(addRow);
}

function filterTable() {
  const query = document.getElementById("searchInput").value.toLowerCase();
  const filtered = loadedData.filter(row =>
    Object.values(row).some(v => (v+"").toLowerCase().includes(query))
  );
  renderTable(filtered);
}

function showForm(mode, id = null) {
  editId = id;
  const form = document.getElementById("recordForm");
  form.innerHTML = "";
  document.getElementById("formTitle").innerText = mode === "create" ? "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å" : "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å";

  currentHeaders.forEach(h => {
    if (h === "ID") return;
    form.innerHTML += `
      <div>
        <label class="block font-medium">${h}</label>
        <input type="text" id="field_${h}" class="border w-full p-2 rounded" />
      </div>
    `;
  });

  document.getElementById("formContainer").classList.remove("hidden");

  if (mode === "edit" && id) {
    const row = loadedData.find(r => r.ID == id);
    currentHeaders.forEach(h => {
      if (h !== "ID") document.getElementById("field_" + h).value = row[h] ?? "";
    });
    document.querySelectorAll("tr").forEach(tr => tr.classList.remove("bg-yellow-100"));
    document.getElementById(`row_${id}`).classList.add("bg-yellow-100");
  }
}

async function submitForm() {
  const data = {};
  currentHeaders.forEach(h => {
    if (h !== "ID") {
      data[h] = document.getElementById("field_" + h).value;
    }
  });

  try {
    if (editId) {
      await fetch(`api.php?table=${currentTable}&action=update&id=${editId}`, {
        method: "POST",
        body: JSON.stringify(data)
      });
      notify("–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!");
    } else {
      await fetch(`api.php?table=${currentTable}&action=create`, {
        method: "POST",
        body: JSON.stringify(data)
      });
      notify("–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
    }
  } catch (e) {
    notify("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏", "error");
  }

  cancelForm();
  loadData();
}

function cancelForm() {
  document.getElementById("formContainer").classList.add("hidden");
  editId = null;
  document.querySelectorAll("tr").forEach(tr => tr.classList.remove("bg-yellow-100"));
}

async function deleteRow(table, id) {
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
  await fetch(`api.php?table=${table}&action=delete&id=${id}`);
  notify("–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞!");
  loadData();
}

// –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
window.onload = () => {
  initTableSelect();
  loadData();
};
</script>

</body>
</html>
